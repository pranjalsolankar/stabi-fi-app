<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Stabi-Fii | Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>

      /* This code only runs on screens smaller than 600px */
/* This only affects mobile/small screens */
@media screen and (max-width: 768px) {
    
    /* 1. Make the black boxes take up the full screen width */
    /* Replace '.card-container' with whatever class your black boxes use */
    .container, [class*="bg-[#0b1120]"] {
        width: 95% !important;
        max-width: 95% !important;
        margin-left: auto !important;
        margin-right: auto !important;
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important; /* Centers everything inside */
        padding: 20px !important;
    }

    /* 2. Center all text and headings */
    h2, p, .text-center {
        text-align: center !important;
        width: 100% !important;
    }

    /* 3. Fix the 'Recent Expenses' row to prevent overflow */
    /* This forces the row to wrap so the + button doesn't go off-screen */
    .flex.gap-2, .recent-expenses-row {
        flex-wrap: wrap !important;
        justify-content: center !important;
    }

    /* 4. Increase size of inputs and buttons for 'zoomed' look */
    input, button {
        width: 100% !important; /* Makes them fill the box width */
        height: 55px !important; /* Larger touch area */
        font-size: 18px !important; /* Larger readable text */
        margin-bottom: 10px !important;
    }

    /* Keep the small Rupee box and + button side-by-side if they fit */
    input[placeholder="₹"], button.bg-pink-500 {
        flex: 1 !important;
        width: auto !important;
    }
}
        body { 
            background: radial-gradient(circle, #ffffff 0%, #f8fafc 100%); 
            min-height: 100vh; 
            color: #0f172a; 
            background-attachment: fixed; 
        }
        .card-custom { 
            border-radius: 24px; 
            background-color: #0f172a; 
            border: 1px solid rgba(0, 0, 0, 0.05); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4); 
        }
        .btn-3d { 
            position: relative; 
            transition: all 0.1s; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 50;
            pointer-events: auto !important;
        }
        .btn-blue-3d { background-color: #3b82f6; box-shadow: 0 5px 0 #1e3a8a; }
        .btn-blue-3d:active { box-shadow: 0 0px 0 #1e3a8a; transform: translateY(5px); }
        .btn-emerald-3d { background-color: #10b981; box-shadow: 0 5px 0 #065f46; }
        .btn-emerald-3d:active { box-shadow: 0 0px 0 #065f46; transform: translateY(5px); }
        .btn-rose-3d { background-color: #f43f5e; box-shadow: 0 5px 0 #9f1239; }
        .btn-rose-3d:active { box-shadow: 0 0px 0 #9f1239; transform: translateY(5px); }
        
        /* Header: Shifted up, black "Welcome", green Name, with shadow */
        .header-container {
            transform: translateY(-20px);
        }
        .welcome-text {
            font-size: 3.5rem;
            font-weight: 900;
            color: #000000; 
            letter-spacing: -0.05em;
            text-shadow: 0px 10px 15px rgba(0,0,0,0.1);
        }
        .user-name {
            color: #10b981; 
        }

        /* Slow and Continuous Blinking for Goal Button */
        @keyframes blink {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.02); box-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
            100% { opacity: 1; transform: scale(1); }
        }
        .blink-effect {
            animation: blink 2.5s linear infinite;
        }

        .money-num { font-weight: 300 !important; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>
<body class="font-sans">

    <nav class="w-full px-10 py-4 flex justify-between items-center max-w-[1400px] mx-auto">
        <div class="flex items-center gap-3"><b class="text-4xl tracking-tighter text-slate-900">Stabi-Fii</b></div>
        <button onclick="logout()" class="px-8 py-3 rounded-xl bg-slate-900 text-white font-black text-xs shadow-lg uppercase">Logout</button>
    </nav>

    <div class="w-full text-center header-container pt-10 pb-4">
        <h1 class="welcome-text">Welcome, <span id="userNameDisplay" class="user-name">User</span></h1>
    </div>

    <main class="max-w-[1300px] mx-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-10 pb-24">
        
        <div class="card-custom p-10 text-white">
            <h3 class="text-2xl font-black text-emerald-400 mb-6 uppercase">Monthly Allowance</h3>
            <div class="space-y-4">
                <input type="number" id="monthlyIncome" placeholder="Amount ₹" onchange="saveIncome()" class="money-num text-3xl w-full bg-slate-800 border border-emerald-500/30 rounded-xl p-5 text-white outline-none">
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-bold text-slate-400 uppercase">Allowance Date</label>
                    <input type="date" id="salaryDate" onchange="saveIncome()" class="bg-slate-800 border border-emerald-500/30 rounded-xl p-4 text-white outline-none w-full">
                </div>
            </div>
        </div>

        <div class="card-custom p-10 text-white">
            <h3 class="text-2xl font-black text-blue-400 mb-2 uppercase">Emergency Vault</h3>
            <div class="money-num mb-8 text-blue-50 text-5xl" id="vaultDisplay">₹0</div>
            <input type="number" id="vaultInput" placeholder="Enter Amount" class="money-num text-2xl w-full bg-slate-800 border border-blue-500/30 rounded-xl p-4 mb-4 text-white outline-none">
            <div class="grid grid-cols-2 gap-4">
                <button type="button" onclick="handleVaultAction('deposit')" class="btn-3d btn-blue-3d py-4 rounded-xl font-black uppercase text-xs">Deposit</button>
                <button type="button" onclick="handleVaultAction('withdraw')" class="btn-3d btn-blue-3d py-4 rounded-xl font-black uppercase text-xs">Withdraw</button>
            </div>
        </div>

        <div class="card-custom p-10 text-white flex flex-col h-[550px]">
            <h3 class="text-2xl font-black text-rose-400 mb-8 uppercase">Recent Expenses</h3>
            <div class="flex gap-3 mb-8">
                <input type="text" id="expName" placeholder="Item" class="flex-1 bg-slate-800 border border-rose-500/30 rounded-xl p-4 outline-none font-black">
                <input type="number" id="expAmt" placeholder="₹" class="money-num text-xl w-32 bg-slate-800 border border-rose-500/30 rounded-xl p-4 outline-none">
                <button onclick="addExpense()" class="btn-3d btn-rose-3d px-10 py-4 rounded-xl font-black text-3xl">+</button>
            </div>
            <div id="expenseList" class="overflow-y-auto flex-1 space-y-4"></div>
        </div>

        <div class="card-custom p-10 text-white flex flex-col">
            <h3 class="text-2xl font-black text-emerald-400 mb-8 uppercase">Financial Status</h3>
            <div class="bg-black/30 rounded-[2rem] flex-1 flex flex-col items-center justify-center border border-white/5 p-12 mb-10 shadow-inner">
                <p class="text-emerald-500/50 text-xs font-black uppercase mb-6">Remaining Balance</p>
                <div class="money-num text-slate-500 text-6xl" id="remainingDisplay">₹---</div>
            </div>
            <div class="grid grid-cols-2 gap-6">
                <button onclick="manualCalculate()" class="btn-3d btn-emerald-3d text-white font-black py-6 rounded-2xl uppercase text-xs">Calculate</button>
                <button id="goalBtn" onclick="navigateToGoals()" class="btn-3d btn-blue-3d text-white font-black py-6 rounded-2xl uppercase text-xs">Set Goals</button>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "https://hwaubxhcclgkcznlqqtk.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_i7iB2vtL50H6tsTDWO_kYA_Mx6ZPpMw";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentVault = 0;
        let expenseData = [];

        window.onload = async () => {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) { window.location.href = 'login.html'; return; }

            const fullName = user.user_metadata?.full_name || user.user_metadata?.name || user.email.split('@')[0];
            document.getElementById('userNameDisplay').innerText = fullName;

            const { data: prof } = await supabaseClient.from("profiles").select("*").eq("id", user.id).maybeSingle();
            if (prof) {
                document.getElementById('monthlyIncome').value = prof.monthly_income || "";
                document.getElementById('salaryDate').value = prof.salary_date || "";
                currentVault = Number(prof.emergency_budget) || 0;
                document.getElementById('vaultDisplay').textContent = "₹" + currentVault.toLocaleString();
            }

            const { data: exps } = await supabaseClient.from("expenses").select("*").eq("user_id", user.id);
            if (exps) { expenseData = exps; renderExpenses(); }
        };

    async function manualCalculate() {
    try {
        const inc = Number(document.getElementById('monthlyIncome').value) || 0;
        const sDate = document.getElementById('salaryDate').value; 
        
        if(!sDate) return alert("Please select a date first!");

        const totalExp = expenseData.reduce((sum, e) => sum + Number(e.amount), 0);
        const bal = inc - totalExp - currentVault;
        
        const { data: { user } } = await supabaseClient.auth.getUser();

        // 1. Save to History (The Boxes)
        // Note: Using 'balance' and 'income' columns seen in your screenshot
        const { error: reportError } = await supabaseClient.from("monthly_reports").upsert({
            user_id: user.id,      
            income: inc,            
            report_month: sDate,   
            vault: currentVault,    
            balance: bal,           
            goals_snapshot: expenseData 
        }, { onConflict: 'user_id, report_month' });

        if (reportError) throw reportError;

        // 2. SYNC GLOBAL BALANCE (Fixes the "Available Money" issue)
        // We update 'final_balance' in profiles to match the calculation
        const { error: profileError } = await supabaseClient
            .from("profiles")
            .update({ final_balance: bal }) 
            .eq("id", user.id);

        if (profileError) throw profileError;

        // 3. Update UI instantly
        document.getElementById('remainingDisplay').textContent = "₹" + bal.toLocaleString();
        
        // Show success animation
        const goalBtn = document.getElementById('goalBtn');
        if (goalBtn) goalBtn.classList.add('blink-effect');

        alert("Calculated and synced successfully!");

    } catch (err) {
        console.error("Error:", err.message);
        alert("Error: " + err.message); // This replaces your generic error message
    }
}
        async function saveIncome() {
            const val = Number(document.getElementById('monthlyIncome').value);
            const sDate = document.getElementById('salaryDate').value;
            const { data: { user } } = await supabaseClient.auth.getUser();
            await supabaseClient.from("profiles").update({ 
                monthly_income: val, 
                salary_date: sDate 
            }).eq("id", user.id);
        }

        async function handleVaultAction(type) {
            const input = document.getElementById('vaultInput');
            const amt = Number(input.value);
            if (!input.value || isNaN(amt)) return;
            const { data: { user } } = await supabaseClient.auth.getUser();
            let newTotal = (type === 'deposit') ? (currentVault + amt) : (currentVault - amt);
            if (newTotal < 0) newTotal = 0;
            const { error } = await supabaseClient.from("profiles").update({ emergency_budget: newTotal }).eq("id", user.id);
            if (!error) {
                currentVault = newTotal;
                document.getElementById('vaultDisplay').textContent = "₹" + currentVault.toLocaleString();
                input.value = '';
                manualCalculate();
            }
        }

        function renderExpenses() {
            document.getElementById('expenseList').innerHTML = expenseData.map(e => `
                <div class="flex justify-between items-center p-6 bg-white/5 rounded-2xl border border-white/5">
                    <div class="flex flex-col">
                        <span class="text-slate-100 font-bold uppercase text-sm">${e.name}</span>
                        <span class="text-rose-400">₹${Number(e.amount).toLocaleString()}</span>
                    </div>
                    <span onclick="deleteExpense('${e.id}')" class="text-rose-500 font-bold cursor-pointer text-xl">✕</span>
                </div>`).join('');
        }

        async function addExpense() {
            const n = document.getElementById('expName').value;
            const a = Number(document.getElementById('expAmt').value);
            if (!n || !a) return;
            const { data: { user } } = await supabaseClient.auth.getUser();
            const { data } = await supabaseClient.from("expenses").insert([{ user_id: user.id, name: n, amount: a }]).select();
            if (data) { 
                expenseData.push(data[0]); 
                renderExpenses(); 
                document.getElementById('expName').value = ''; 
                document.getElementById('expAmt').value = ''; 
                manualCalculate();
            }
        }

        async function deleteExpense(id) {
            await supabaseClient.from("expenses").delete().eq("id", id);
            expenseData = expenseData.filter(e => e.id !== id);
            renderExpenses();
            manualCalculate();
        }

        function navigateToGoals() { window.location.href = 'stugoal.html'; }
        async function logout() { await supabaseClient.auth.signOut(); window.location.href = 'login.html'; }
    </script>
</body>
</html>